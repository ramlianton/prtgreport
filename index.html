<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTG Pro: Chart + 95th Percentile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .table-container { overflow-x: auto; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                PRTG Report Extractor <span class="text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded ml-2">PRO v2.0</span>
            </h1>
            <p class="text-slate-600">Analisis Trafik, Visualisasi, dan Perhitungan 95th Percentile.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="font-semibold text-slate-700 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        Upload PDF
                    </h3>
                    <div class="relative group">
                        <input type="file" id="pdfFile" accept="application/pdf" class="hidden" onchange="handleFileUpload(this)">
                        <label for="pdfFile" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer bg-slate-50 group-hover:bg-slate-100 group-hover:border-blue-400 transition-all">
                            <div id="uploadStatus" class="flex flex-col items-center">
                                <svg class="w-8 h-8 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span class="text-xs text-slate-500 text-center px-2">Klik untuk pilih file PDF</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="font-semibold text-slate-700 mb-4">Metode Lain</h3>
                    <button onclick="focusRawInput()" class="w-full py-2 px-4 border border-slate-200 rounded-lg text-sm text-slate-600 hover:bg-slate-50 transition-colors">
                        Gunakan Copy-Paste Teks
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 h-full flex flex-col">
                    
                    <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-bold text-indigo-800 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                            Filter Data (Grafik & Tabel)
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-indigo-700 mb-1">Tanggal</label>
                                <input type="date" id="filterDate" class="w-full px-3 py-1.5 border border-indigo-200 rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-indigo-700 mb-1">Shift</label>
                                <select id="filterShift" class="w-full px-3 py-1.5 border border-indigo-200 rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="all">Semua Jam</option>
                                    <option value="1">Shift 1 (08:00 - 17:00)</option>
                                    <option value="2">Shift 2 (17:00 - 21:00)</option>
                                    <option value="3">Shift 3 (21:00 - 04:00)</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="applyFilters()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded text-sm font-medium transition-colors shadow-sm">
                                    Terapkan Filter
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-semibold text-slate-700">Preview Teks / Input Manual:</label>
                        <div id="loadingIndicator" class="hidden flex items-center gap-2 text-blue-600 text-xs font-medium">
                            <div class="loading-spinner"></div> Memproses PDF...
                        </div>
                    </div>
                    <textarea 
                        id="rawInput" 
                        class="flex-grow w-full p-4 text-xs font-mono border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none h-24"
                        placeholder="Tempel data teks di sini atau upload PDF..."></textarea>
                    
                    <div class="flex gap-3 mt-4">
                        <button 
                            onclick="processData()"
                            class="bg-slate-800 hover:bg-slate-900 text-white px-8 py-2.5 rounded-lg font-semibold transition-colors flex items-center">
                            Proses Data Awal
                        </button>
                        <button 
                            onclick="clearInput()"
                            class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-6 py-2.5 rounded-lg font-semibold transition-colors">
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultContainer" class="hidden space-y-6">
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                         <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Informasi Laporan
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Judul Laporan</label>
                                <input type="text" id="pdfTitle" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: LAPORAN TRAFIK HARIAN">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Keterangan Filter</label>
                                <input type="text" id="activeFilterInfo" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600 cursor-default" readonly value="Semua Data">
                            </div>
                        </div>
                    </div>
                     <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Catatan Tambahan</label>
                        <textarea id="pdfNotes" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none h-20" placeholder="Tambahkan catatan khusus untuk laporan ini..."></textarea>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                        Grafik Trafik (Sesuai Filter)
                    </h3>
                    <div class="text-xs text-slate-400">Menampilkan data berdasarkan filter tanggal/jam yang aktif</div>
                </div>
                <div class="w-full h-80 relative">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>

            <div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                    <h2 class="text-xl font-bold text-slate-800">Tabel Ringkasan</h2>
                    <div class="flex gap-2">
                        <button 
                            onclick="exportToPDF()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors shadow-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Export PDF
                        </button>
                        <button 
                            onclick="copyTable()"
                            class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors shadow-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m-1 4h.01M9 16h.01M9 12h.01M12 12h.01M12 16h.01M15 12h.01M15 16h.01"></path></svg>
                            Salin Tabel
                        </button>
                    </div>
                </div>

                <div class="table-container bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                    <table class="w-full text-left text-xs border-collapse" id="resultTable">
                        <thead>
                            <tr class="bg-slate-900 text-white">
                                <th class="px-4 py-4 font-semibold border-b">Device Info</th>
                                <th class="px-4 py-4 font-semibold border-b text-center">Uptime</th>
                                <th class="px-4 py-4 font-semibold border-b text-center">Coverage</th>
                                <th class="px-4 py-4 font-semibold border-b bg-blue-900">Avg Traffic</th>
                                <th class="px-4 py-4 font-semibold border-b bg-indigo-900 border-l border-indigo-700">95th Percentile</th>
                                <th class="px-4 py-4 font-semibold border-b bg-blue-900">Highest (Peak)</th>
                                <th class="px-4 py-4 font-semibold border-b bg-blue-900">Lowest (Trough)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="emptyState" class="text-center py-20 bg-white rounded-xl border-2 border-dashed border-slate-200 text-slate-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <p>Belum ada data yang diproses. Silakan upload PDF atau tempel teks laporan.</p>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let globalRawData = [];
        let extractedData = []; 
        let chartInstance = null; // Store chart instance to update/destroy

        // Warna untuk Line Chart (Palette)
        const CHART_COLORS = [
            'rgb(59, 130, 246)',   // Blue
            'rgb(239, 68, 68)',    // Red
            'rgb(16, 185, 129)',   // Green
            'rgb(245, 158, 11)',   // Amber
            'rgb(139, 92, 246)',   // Violet
            'rgb(236, 72, 153)',   // Pink
            'rgb(99, 102, 241)'    // Indigo
        ];

        function focusRawInput() {
            document.getElementById('rawInput').focus();
        }

        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            const loading = document.getElementById('loadingIndicator');
            const statusText = document.querySelector('#uploadStatus span');
            
            loading.classList.remove('hidden');
            statusText.innerText = "Mengekstrak teks...";

            reader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = '';

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n\n--- PAGE " + i + " ---\n\n";
                    }

                    document.getElementById('rawInput').value = fullText;
                    statusText.innerText = file.name + " berhasil dimuat";
                    processData();
                } catch (error) {
                    console.error(error);
                    alert('Gagal membaca PDF. Pastikan file tidak rusak.');
                } finally {
                    loading.classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function clearInput() {
            document.getElementById('rawInput').value = '';
            document.getElementById('pdfFile').value = '';
            document.querySelector('#uploadStatus span').innerText = "Klik untuk pilih file PDF";
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            globalRawData = [];
            extractedData = [];
            if(chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        function parseTimeStr(timeStr) {
            if(timeStr.includes(' ')) {
               if (timeStr.match(/^\d+\/\d+\/\d+/)) {
                   timeStr = timeStr.split(' ').slice(1).join(' '); 
               }
            }
            const parts = timeStr.trim().split(/[:\s]/);
            let hours = parseInt(parts[0]);
            const minutes = parseInt(parts[1]);
            const ampm = parts[3] ? parts[3].toUpperCase() : '';

            if (ampm === 'PM' && hours < 12) hours += 12;
            if (ampm === 'AM' && hours === 12) hours = 0;
            
            return { h: hours, m: minutes };
        }

        function isTimeInShift(timeStr, shift) {
            const { h } = parseTimeStr(timeStr);
            if (shift === '1') return h >= 8 && h < 17;
            else if (shift === '2') return h >= 17 && h < 21;
            else if (shift === '3') return h >= 21 || h < 4;
            return true;
        }

        function processData() {
            const input = document.getElementById('rawInput').value;
            if (!input.trim()) return;

            const cleanInput = input.replace(/−/g, '-').replace(/”/g, '"').replace(/“/g, '"');
            const blocks = cleanInput.split(/Report for\s+\(\d+\)\s+.*?Traffic/i);
            
            globalRawData = []; 

            blocks.forEach((block, index) => {
                if (index === 0 && !block.includes('Probe, Group, Device:')) return;

                const deviceMatch = block.match(/Probe,\s*Group,\s*Device:\s*(.*?)(?=Uptime Stats|Request Stats|Average|$)/s);
                let deviceName = deviceMatch ? deviceMatch[1].trim() : 'Unknown Device';
                
                let cleanName = deviceName.split('>').pop().trim().split('(')[0].trim();
                let parentInfo = deviceName.includes('>') ? deviceName.split('>').slice(-2, -1)[0].trim() : '';

                const uptimeMatch = block.match(/Up:\s*([\d.]+)\s*%\s*\[(.*?s)\]/i);
                const uptime = uptimeMatch ? `${uptimeMatch[1]}%` : '-';

                const reqMatch = block.match(/Good:\s*([\d.]+)\s*%\s*\[(\d+)\]/i);
                const reqValue = reqMatch ? `${reqMatch[2]} (${reqMatch[1]}%)` : '-';

                const coverageMatch = block.match(/Averages.*?\d+\s*%\s*(\d+)\s*%/);
                const coverage = coverageMatch ? coverageMatch[1] + '%' : '100%';

                const rawRows = [];
                const rowRegex = /"(\d+\/\d+\/\d+)","(\d+:\d+:\d+\s+[AP]M.*?)"(?:,"[\d,.]+\s+MB")?,"([\d,.]+\s+Mbit\/s)"/g;
                let match;
                
                while ((match = rowRegex.exec(block)) !== null) {
                    rawRows.push({
                        date: match[1],
                        time: match[2].replace(/\s+/g, ' ').trim(),
                        speed: parseFloat(match[3].replace(',', '').trim())
                    });
                }

                if (rawRows.length === 0) {
                    const fallbackRegex = /(\d+\/\d+\/\d+)\s+(\d+:\d+:\d+\s+[AP]M)\s*-\s*\d+:\d+:\d+\s+[AP]M\s*[\d,.]+\s*MB\s*([\d,.]+\s*Mbit\/s)/g;
                    while ((match = fallbackRegex.exec(block)) !== null) {
                        rawRows.push({
                            date: match[1],
                            time: match[2].trim(),
                            speed: parseFloat(match[3].replace(',', '').trim())
                        });
                    }
                }

                if (cleanName || uptime !== '-') {
                    globalRawData.push({
                        deviceId: cleanName,
                        location: parentInfo,
                        uptime: uptime,
                        request: reqValue,
                        coverage: coverage,
                        rows: rawRows
                    });
                }
            });

            if (globalRawData.length > 0 && globalRawData[0].rows.length > 0) {
                const firstDate = globalRawData[0].rows[0].date;
                const parts = firstDate.split('/');
                if (parts.length === 3) {
                    const y = parts[2];
                    const m = parts[0].padStart(2, '0');
                    const d = parts[1].padStart(2, '0');
                    const isoDate = `${y}-${m}-${d}`;
                    const dateInput = document.getElementById('filterDate');
                    if (!dateInput.value) dateInput.value = isoDate;
                }
            }

            applyFilters();
        }

        function applyFilters() {
            const dateFilter = document.getElementById('filterDate').value; 
            const shiftFilter = document.getElementById('filterShift').value;
            
            const results = [];
            const chartDatasets = [];
            let chartLabels = [];
            let isLabelsSet = false;

            let filterDesc = "Semua Data";
            if (dateFilter || shiftFilter !== 'all') {
                filterDesc = "";
                if (dateFilter) filterDesc += `Tgl: ${dateFilter} `;
                if (shiftFilter !== 'all') filterDesc += `| Shift: ${shiftFilter}`;
            }
            document.getElementById('activeFilterInfo').value = filterDesc;

            globalRawData.forEach((device, index) => {
                let validRows = device.rows.filter(row => {
                    let dateMatch = true;
                    let shiftMatch = true;

                    if (dateFilter) {
                        const d1 = new Date(dateFilter);
                        const d2 = new Date(row.date);
                        dateMatch = d1.toDateString() === d2.toDateString();
                    }

                    if (shiftFilter !== 'all') {
                        shiftMatch = isTimeInShift(row.time, shiftFilter);
                    }

                    return dateMatch && shiftMatch;
                });

                // --- CHART DATA PREPARATION ---
                if (validRows.length > 0) {
                     if (!isLabelsSet) {
                        chartLabels = validRows.map(r => r.time);
                        isLabelsSet = true;
                    }
                    
                    const color = CHART_COLORS[index % CHART_COLORS.length];
                    
                    chartDatasets.push({
                        label: device.deviceId,
                        data: validRows.map(r => r.speed),
                        borderColor: color,
                        backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                        borderWidth: 2,
                        pointRadius: 1,
                        tension: 0.1, 
                        fill: false
                    });
                }

                // --- STATS CALCULATION ---
                let highest = { speed: -1, time: '-' };
                let lowest = { speed: Infinity, time: '-' };
                let sum = 0;
                
                // Collect speeds for P95 calc
                let speedArray = [];

                validRows.forEach(r => {
                    speedArray.push(r.speed);
                    if (r.speed > highest.speed) highest = r;
                    if (r.speed < lowest.speed) lowest = r;
                    sum += r.speed;
                });

                // 95th Percentile Calculation
                let p95Value = '-';
                if (speedArray.length > 0) {
                    // Sort numeric ascending
                    speedArray.sort((a, b) => a - b);
                    // Index calculation (95% of length)
                    let index95 = Math.floor(speedArray.length * 0.95);
                    // Safe guard index
                    if (index95 >= speedArray.length) index95 = speedArray.length - 1;
                    p95Value = speedArray[index95].toFixed(2) + ' Mbit/s';
                }

                let avg = validRows.length > 0 ? (sum / validRows.length).toFixed(2) : '-';

                if (validRows.length > 0 || device.uptime !== '-') {
                    results.push({
                        deviceId: device.deviceId,
                        location: device.location,
                        uptime: device.uptime,
                        request: device.request,
                        coverage: device.coverage,
                        avg: avg,
                        p95: p95Value, // Data baru
                        max: highest.speed === -1 ? '-' : `${highest.speed} Mbit/s`,
                        maxTime: highest.time !== '-' ? highest.time : '',
                        min: lowest.speed === Infinity ? '-' : `${lowest.speed} Mbit/s`,
                        minTime: lowest.time !== '-' ? lowest.time : ''
                    });
                }
            });

            extractedData = results;
            renderTable(results);
            renderChart(chartLabels, chartDatasets);

            if (results.length > 0) {
                document.getElementById('resultContainer').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('hidden');
            } else {
                alert('Tidak ada data yang cocok dengan filter Tanggal/Shift tersebut.');
                document.getElementById('tableBody').innerHTML = '';
                if(chartInstance) chartInstance.data.datasets = [];
            }
        }

        function renderChart(labels, datasets) {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 10,
                                font: { size: 10 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' Mbit/s';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                maxTicksLimit: 10, 
                                font: { size: 10 }
                            },
                            grid: { display: false }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Traffic (Mbit/s)',
                                font: { size: 10 }
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors";
                row.innerHTML = `
                    <td class="px-4 py-3 border-b">
                        <div class="font-bold text-slate-800 leading-tight">${item.deviceId}</div>
                        <div class="text-[10px] text-slate-500 uppercase tracking-wider">${item.location}</div>
                    </td>
                    <td class="px-4 py-3 border-b text-slate-700 font-semibold text-center">${item.uptime}</td>
                    <td class="px-4 py-3 border-b text-center">
                        <span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-800 text-[10px] font-bold">${item.coverage}</span>
                    </td>
                    <td class="px-4 py-3 border-b bg-blue-50 font-bold text-blue-700 text-sm italic">${item.avg} <span class="text-[9px] font-normal not-italic">Mbps</span></td>
                    <td class="px-4 py-3 border-b bg-indigo-50 border-l border-indigo-200">
                         <div class="font-bold text-indigo-800">${item.p95}</div>
                         <div class="text-[9px] text-indigo-400 font-medium">Burstable</div>
                    </td>
                    <td class="px-4 py-3 border-b bg-blue-50">
                        <div class="font-bold text-slate-800">${item.max}</div>
                        <div class="text-[9px] text-blue-600 font-medium">${item.maxTime}</div>
                    </td>
                    <td class="px-4 py-3 border-b bg-blue-50">
                        <div class="font-bold text-slate-800">${item.min}</div>
                        <div class="text-[9px] text-slate-500 font-medium">${item.minTime}</div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function copyTable() {
            const range = document.createRange();
            range.selectNode(document.getElementById("resultTable"));
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                document.execCommand('copy');
                alert('Tabel berhasil disalin!');
            } catch (err) {
                alert('Gagal menyalin tabel.');
            }
            window.getSelection().removeAllRanges();
        }

        async function exportToPDF() {
            if (extractedData.length === 0) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); 

            const title = document.getElementById('pdfTitle').value || 'PRTG TRAFFIC REPORT';
            const filterInfo = document.getElementById('activeFilterInfo').value;
            const notes = document.getElementById('pdfNotes').value || '';

            // Styling Header
            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.text(title, 14, 20);

            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Filter: ${filterInfo}`, 14, 27);

            // Capture Chart as Image to add to PDF
            const canvas = document.getElementById('trafficChart');
            const chartImg = canvas.toDataURL('image/png', 1.0);
            
            doc.addImage(chartImg, 'PNG', 14, 35, 270, 80); 

            const tableRows = extractedData.map(item => [
                `${item.deviceId}\n(${item.location})`,
                item.uptime,
                item.coverage,
                `${item.avg} Mbps`,
                item.p95, // Add P95 to PDF
                `${item.max}\n@ ${item.maxTime}`,
                `${item.min}\n@ ${item.minTime}`
            ]);

            doc.autoTable({
                head: [['Device Info', 'Uptime', 'Cov', 'Avg Traffic', '95th %', 'Highest (Peak)', 'Lowest (Trough)']],
                body: tableRows,
                startY: 120, // Start below chart
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42], fontSize: 9, halign: 'center' },
                styles: { fontSize: 8, valign: 'middle' },
                columnStyles: {
                    0: { cellWidth: 45 },
                    1: { halign: 'center' },
                    2: { halign: 'center' },
                    4: { fontStyle: 'bold', fillColor: [224, 231, 255], textColor: [55, 48, 163] }, // Highlight P95 column
                    3: { fontStyle: 'bold', textColor: [29, 78, 216] }
                }
            });

            if (notes) {
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10);
                doc.setTextColor(40);
                doc.text('Catatan:', 14, finalY);
                doc.setFontSize(9);
                doc.setTextColor(100);
                const splitNotes = doc.splitTextToSize(notes, 260);
                doc.text(splitNotes, 14, finalY + 5);
            }

            doc.save(`PRTG_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        }
    </script>
    <footer class="mt-12 py-4 text-center text-xs text-gray-400 border-t border-gray-200">
      © 2026 · Created by <span class="text-gray-600 font-medium">Ramli Anton</span>
    </footer>

</body>
</html>
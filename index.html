<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTG Report Data Extractor + Export PDF</title>
    <link rel="stylesheet" href="output.css">
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- jsPDF & AutoTable for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .table-container { overflow-x: auto; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                PRTG Report Extractor
            </h1>
            <p class="text-slate-600">Ekstrak data ringkasan trafik dari teks copy-paste atau file PDF PRTG.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Left Panel: Input -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="font-semibold text-slate-700 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        Upload PDF
                    </h3>
                    <div class="relative group">
                        <input type="file" id="pdfFile" accept="application/pdf" class="hidden" onchange="handleFileUpload(this)">
                        <label for="pdfFile" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer bg-slate-50 group-hover:bg-slate-100 group-hover:border-blue-400 transition-all">
                            <div id="uploadStatus" class="flex flex-col items-center">
                                <svg class="w-8 h-8 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span class="text-xs text-slate-500 text-center px-2">Klik untuk pilih file PDF</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="font-semibold text-slate-700 mb-4">Metode Lain</h3>
                    <button onclick="focusRawInput()" class="w-full py-2 px-4 border border-slate-200 rounded-lg text-sm text-slate-600 hover:bg-slate-50 transition-colors">
                        Gunakan Copy-Paste Teks
                    </button>
                </div>
            </div>

            <!-- Right Panel: Text Area -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <label class="block text-sm font-semibold text-slate-700">Preview Teks / Input Manual:</label>
                        <div id="loadingIndicator" class="hidden flex items-center gap-2 text-blue-600 text-xs font-medium">
                            <div class="loading-spinner"></div> Memproses PDF...
                        </div>
                    </div>
                    <textarea 
                        id="rawInput" 
                        class="flex-grow w-full p-4 text-xs font-mono border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none"
                        placeholder="Tempel data teks di sini atau upload PDF..."></textarea>
                    
                    <div class="flex gap-3 mt-4">
                        <button 
                            onclick="processData()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded-lg font-semibold transition-colors flex items-center">
                            Ekstrak Data
                        </button>
                        <button 
                            onclick="clearInput()"
                            class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-6 py-2.5 rounded-lg font-semibold transition-colors">
                            Hapus
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div id="resultContainer" class="hidden space-y-6">
            <!-- Metadata Laporan -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    Informasi Laporan
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Judul Laporan</label>
                        <input type="text" id="pdfTitle" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: LAPORAN TRAFIK HARIAN">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Subjudul</label>
                        <input type="text" id="pdfSubtitle" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: UNIT NETWORK OPERATIONS">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Rentang Tanggal (Terdeteksi)</label>
                    <input type="text" id="detectedRange" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600 cursor-default" readonly>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Catatan Tambahan</label>
                    <textarea id="pdfNotes" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none h-20" placeholder="Tambahkan catatan khusus di sini..."></textarea>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h2 class="text-xl font-bold text-slate-800">Hasil Ekstraksi</h2>
                <div class="flex gap-2">
                    <button 
                        onclick="exportToPDF()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors shadow-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Export PDF
                    </button>
                    <button 
                        onclick="copyTable()"
                        class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors shadow-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m-1 4h.01M9 16h.01M9 12h.01M12 12h.01M12 16h.01M15 12h.01M15 16h.01"></path></svg>
                        Salin Tabel
                    </button>
                </div>
            </div>

            <div class="table-container bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                <table class="w-full text-left text-xs border-collapse" id="resultTable">
                    <thead>
                        <tr class="bg-slate-900 text-white">
                            <th class="px-4 py-4 font-semibold border-b">Device Info</th>
                            <th class="px-4 py-4 font-semibold border-b text-center">Uptime</th>
                            <th class="px-4 py-4 font-semibold border-b">Req Sensor</th>
                            <th class="px-4 py-4 font-semibold border-b text-center">Coverage</th>
                            <th class="px-4 py-4 font-semibold border-b bg-blue-900">Avg Traffic IN</th>
                            <th class="px-4 py-4 font-semibold border-b bg-blue-900">Highest (Peak)</th>
                            <th class="px-4 py-4 font-semibold border-b bg-blue-900">Lowest (Trough)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-200">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="emptyState" class="text-center py-20 bg-white rounded-xl border-2 border-dashed border-slate-200 text-slate-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <p>Belum ada data yang diproses. Silakan upload PDF atau tempel teks laporan.</p>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let extractedData = [];

        function focusRawInput() {
            document.getElementById('rawInput').focus();
        }

        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            const loading = document.getElementById('loadingIndicator');
            const statusText = document.querySelector('#uploadStatus span');
            
            loading.classList.remove('hidden');
            statusText.innerText = "Mengekstrak teks...";

            reader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = '';

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n\n--- PAGE " + i + " ---\n\n";
                    }

                    document.getElementById('rawInput').value = fullText;
                    statusText.innerText = file.name + " berhasil dimuat";
                    processData();
                } catch (error) {
                    console.error(error);
                    alert('Gagal membaca PDF. Pastikan file tidak rusak.');
                } finally {
                    loading.classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function clearInput() {
            document.getElementById('rawInput').value = '';
            document.getElementById('pdfFile').value = '';
            document.querySelector('#uploadStatus span').innerText = "Klik untuk pilih file PDF";
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            extractedData = [];
        }

        function processData() {
            const input = document.getElementById('rawInput').value;
            if (!input.trim()) return;

            // Normalize input
            const cleanInput = input.replace(/−/g, '-').replace(/”/g, '"').replace(/“/g, '"');

            // Extract Date Range
            const rangeMatch = cleanInput.match(/Report Time Span:\s*(.*?)(?=\n|Sensor Type|---|$)/i);
            const dateRange = rangeMatch ? rangeMatch[1].trim() : '-';
            document.getElementById('detectedRange').value = dateRange;

            // Split into blocks per device report
            const blocks = cleanInput.split(/Report for\s+\(\d+\)\s+.*?Traffic/i);
            
            const results = [];

            blocks.forEach((block, index) => {
                if (index === 0 && !block.includes('Probe, Group, Device:')) return;

                const deviceMatch = block.match(/Probe,\s*Group,\s*Device:\s*(.*?)(?=Uptime Stats|Request Stats|Average|$)/s);
                let deviceName = deviceMatch ? deviceMatch[1].trim() : 'Unknown Device';
                
                let cleanName = deviceName.split('>').pop().trim().split('(')[0].trim();
                let parentInfo = deviceName.includes('>') ? deviceName.split('>').slice(-2, -1)[0].trim() : '';

                const uptimeMatch = block.match(/Up:\s*([\d.]+)\s*%\s*\[(.*?s)\]/i);
                const uptime = uptimeMatch ? `${uptimeMatch[1]}%` : '-';

                const reqMatch = block.match(/Good:\s*([\d.]+)\s*%\s*\[(\d+)\]/i);
                const reqValue = reqMatch ? `${reqMatch[2]} (${reqMatch[1]}%)` : '-';

                const coverageMatch = block.match(/Averages.*?\d+\s*%\s*(\d+)\s*%/);
                const coverage = coverageMatch ? coverageMatch[1] + '%' : '100%';

                const avgTrafficMatch = block.match(/Average\s*\(Traffic\s+(?:In|Total)\):\s*([\d,.]+)\s*Mbit\/s/i);
                const avgTraffic = avgTrafficMatch ? avgTrafficMatch[1] : '-';

                const tableRows = [];
                const rowRegex = /"(\d+\/\d+\/\d+)","(\d+:\d+:\d+\s+[AP]M.*?)"(?:,"[\d,.]+\s+MB")?,"([\d,.]+\s+Mbit\/s)"/g;
                let match;
                while ((match = rowRegex.exec(block)) !== null) {
                    tableRows.push({
                        time: match[2].replace(/\s+/g, ' ').trim(),
                        speed: parseFloat(match[3].replace(',', '').trim())
                    });
                }

                if (tableRows.length === 0) {
                    const fallbackRegex = /(\d+:\d+:\d+\s+[AP]M\s*-\s*\d+:\d+:\d+\s+[AP]M)\s*[\d,.]+\s*MB\s*([\d,.]+\s*Mbit\/s)/g;
                    while ((match = fallbackRegex.exec(block)) !== null) {
                        tableRows.push({
                            time: match[1].trim(),
                            speed: parseFloat(match[2].replace(',', '').trim())
                        });
                    }
                }

                let highest = { speed: -1, time: '-' };
                let lowest = { speed: Infinity, time: '-' };

                tableRows.forEach(row => {
                    if (row.speed > highest.speed) highest = row;
                    if (row.speed < lowest.speed) lowest = row;
                });

                if (cleanName || uptime !== '-') {
                    results.push({
                        deviceId: cleanName,
                        location: parentInfo,
                        uptime: uptime,
                        request: reqValue,
                        coverage: coverage,
                        avg: avgTraffic,
                        max: highest.speed === -1 ? '-' : `${highest.speed} Mbit/s`,
                        maxTime: highest.time.split('-')[0].trim().split(' ')[0] + ' ' + (highest.time.includes('AM') ? 'AM' : 'PM'),
                        min: lowest.speed === Infinity ? '-' : `${lowest.speed} Mbit/s`,
                        minTime: lowest.time.split('-')[0].trim().split(' ')[0] + ' ' + (lowest.time.includes('AM') ? 'AM' : 'PM')
                    });
                }
            });

            extractedData = results;
            if (results.length > 0) {
                renderTable(results);
            } else {
                alert('Tidak ada data valid yang ditemukan.');
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors";
                row.innerHTML = `
                    <td class="px-4 py-3 border-b">
                        <div class="font-bold text-slate-800 leading-tight">${item.deviceId}</div>
                        <div class="text-[10px] text-slate-500 uppercase tracking-wider">${item.location}</div>
                    </td>
                    <td class="px-4 py-3 border-b text-slate-700 font-semibold text-center">${item.uptime}</td>
                    <td class="px-4 py-3 border-b text-slate-600">${item.request}</td>
                    <td class="px-4 py-3 border-b text-center">
                        <span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-800 text-[10px] font-bold">${item.coverage}</span>
                    </td>
                    <td class="px-4 py-3 border-b bg-blue-50 font-bold text-blue-700 text-sm italic">${item.avg} <span class="text-[9px] font-normal not-italic">Mbps</span></td>
                    <td class="px-4 py-3 border-b bg-blue-50">
                        <div class="font-bold text-slate-800">${item.max}</div>
                        <div class="text-[9px] text-blue-600 font-medium">${item.maxTime}</div>
                    </td>
                    <td class="px-4 py-3 border-b bg-blue-50">
                        <div class="font-bold text-slate-800">${item.min}</div>
                        <div class="text-[9px] text-slate-500 font-medium">${item.minTime}</div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.getElementById('resultContainer').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function copyTable() {
            const range = document.createRange();
            range.selectNode(document.getElementById("resultTable"));
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                document.execCommand('copy');
                const btn = event.currentTarget;
                const originalText = btn.innerHTML;
                btn.innerText = "Tersalin!";
                btn.classList.replace('bg-slate-800', 'bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-green-600', 'bg-slate-800');
                }, 2000);
            } catch (err) {
                alert('Gagal menyalin tabel.');
            }
            window.getSelection().removeAllRanges();
        }

        async function exportToPDF() {
            if (extractedData.length === 0) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

            const title = document.getElementById('pdfTitle').value || 'PRTG TRAFFIC REPORT';
            const subtitle = document.getElementById('pdfSubtitle').value || 'Summary Extraction';
            const dateRange = document.getElementById('detectedRange').value || '-';
            const notes = document.getElementById('pdfNotes').value || '';

            // Styling Header
            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.text(title, 14, 20);

            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(subtitle, 14, 27);

            doc.setFontSize(10);
            doc.setTextColor(80);
            doc.text(`Rentang Waktu: ${dateRange}`, 14, 34);

            const tableRows = extractedData.map(item => [
                `${item.deviceId}\n(${item.location})`,
                item.uptime,
                item.request,
                item.coverage,
                `${item.avg} Mbps`,
                `${item.max}\n@ ${item.maxTime}`,
                `${item.min}\n@ ${item.minTime}`
            ]);

            doc.autoTable({
                head: [['Device Info', 'Uptime', 'Req Sensor', 'Cov', 'Avg Traffic IN', 'Highest (Peak)', 'Lowest (Trough)']],
                body: tableRows,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42], fontSize: 9, halign: 'center' },
                styles: { fontSize: 8, valign: 'middle' },
                columnStyles: {
                    0: { cellWidth: 45 },
                    1: { halign: 'center' },
                    3: { halign: 'center' },
                    4: { fontStyle: 'bold', textColor: [29, 78, 216] }
                }
            });

            if (notes) {
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10);
                doc.setTextColor(40);
                doc.text('Catatan:', 14, finalY);
                doc.setFontSize(9);
                doc.setTextColor(100);
                const splitNotes = doc.splitTextToSize(notes, 260);
                doc.text(splitNotes, 14, finalY + 5);
            }

            doc.save(`PRTG_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        }
    </script>
</body>
</html>